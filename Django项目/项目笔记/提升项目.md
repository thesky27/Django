# 一、项目配置

### 1.虚拟环境及模块

```python
mkvirtualenv -p /usr/bin/python3 promote	#创建虚拟环境
pip install django -i https://pypi.douban.com/simple/#安装django模块
pip install djangorestframework -i https://pypi.douban.com/simple/#djangorestframework
pip install pymysql -i https://pypi.douban.com/simple/ #安装pymysql模块
```

### 2.数据库的创建

```python
create database `promote` charset='utf8';#
GRANT ALL PRIVILEGES ON `PTOMOTE`.* To 'promoteu'@'%' IDENTIFIED BY 'qwe123';
flush peivileges;
exit;
mysql -upromote -p
#你的密码
```

### 3.创建django项目

```python
django-admin startproject promote
```

- 进行pycharm的配置，连接虚拟机上的django项目，进行同步目录以及解释器的配置。
- 直至运行项目打开网页端出现小火箭。

### 4.django项目的初始配置

1.settings文件配置

```python
import datetime
import os
import sys
from pathlib import Path
DATABASES = {
    'sqlite3': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': BASE_DIR / 'db.sqlite3',
    },
    'default': {
        'ENGINE': 'django.db.backends.mysql',
        'OPTIONS': {
            'read_default_file':'config/dbs/mysql.cnf'
        }
    }
}
#时间的配置
LANGUAGE_CODE = 'zh-hans'

TIME_ZONE = 'Asia/Shanghai'

USE_I18N = True

USE_L10N = True

USE_TZ = False
#日志的使用
# 配置日志器，记录网站的日志信息
LOGGING = {
    # 版本
    'version': 1,
    # 是否禁用已存在的日志器
    'disable_existing_loggers': False,
    'formatters': {
        'verbose': {
            'format': '%(levelname)s %(asctime)s %(module)s %(lineno)d %(message)s'
        },
        'simple': {
            'format': '%(levelname)s %(module)s %(lineno)d %(message)s'
        },
    },
    'filters': {
        'require_debug_true': {
            '()': 'django.utils.log.RequireDebugTrue',
        },
    },
    'handlers': {
        'console': {
            'level': 'DEBUG',
            'filters': ['require_debug_true'],
            'class': 'logging.StreamHandler',
            'formatter': 'simple'
        },
        'file': {
            'level': 'INFO',
            'class': 'logging.handlers.RotatingFileHandler',
            'filename': os.path.join(BASE_DIR, "logs/promote.log"),  # 日志文件的位置
            'maxBytes': 300 * 1024 * 1024,
            'backupCount': 10,
            'formatter': 'verbose'
        },
    },
    'loggers': {
        'django': {  # 定义了一个名为django的日志器
            'handlers': ['console', 'file'],
            'propagate': True,
            'level': 'INFO',  # 日志器接收的最低日志级别
        },
    }
}

```

2.数据库配置文件mysql.cnf

```python
[client]
database = 数据库名
user = 用户
password = 密码
host = 127.0.0.1
port = 3306
default-character-set = utf8
```

3.init文件配置

```python
import pymysql
pymysql.install_as_MySQLdb()
```

- 开启端口，再次检查小火箭是否能进行。如果能显示小火箭就能说明配置无问题

### 5.app文件夹的创建

将apps文件夹设置为资源目录，并进行settings文件的配置。（将apps添加到目录中，方便导包）

```python
import datetime
import os
import sys
from pathlib import Path

# Build paths inside the project like this: BASE_DIR / 'subdir'.
BASE_DIR = Path(__file__).resolve().parent.parent
sys.path.insert(0,BASE_DIR)
sys.path.insert(1,os.path.join(BASE_DIR,'apps'))
```

# 二、完成登录接口开发

### 1.后台的测试

#### 1.1创建超级管理员

- 在pycharm中打开控制台——CTRL+alt+r

- ```python
  makemigrations	#生成映射
  migrate	#提交映射
  createsuperuser#生成超级管理员用户
  账号:yige
  密码:yige123
  ```

#### 1.2定义身份

在django的admin中创建老师和学生，比进行权限的分配和分组。操作权限相当于校长。

### 2.token令牌介绍

- 在一次登陆之后发放有一定时限的令牌，之后在有效期内，服务器进行token是否过期和是否正确的验证。
- token的本质是一串密文。不需要服务器频繁的与数据库交互来查询账号密码是否正确。
- 本质是字符串数据，前端数据可以是任意语言。

#### 2.1JWT

JSON Web Token：是token令牌生成的规范。三部分组成

- header 头部——包含加密方式通常使用HMAC，SHA256加密方式

- payload 载体数据——使用者的信息，token要包含的数据

- signature 签名——将Header和payload使用Base64编码生成，加入签名字符用机密算法加密一遍，得到唯一的签名。防止他人盗取篡改。

在settings配置文件里一定要保护好私钥，有了私钥就可以伪造令牌。

```python
from config.secret import SECRET_KEY
# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = SECRET_KEY
```

- 如果要上传github或者gitee，一定要更改.gitignore文件，确保配置文件不会上传

### 3.token的使用

#### 3.1token过期时间配置

djangorestframework-jwt模块的安装

```python
# 过期时间配置
JWT_AUTH = {
    'JWT_EXPIRATION_DELTA': datetime.timedelta(days=1),
    'JWT_RESPONSE_PAYLOAD_HANDLER': 'users.utils.jwt_token',
}

REST_FRAMEWORK = {
    'DEFAULT_AUTHENTICATION_CLASSES': (
        'rest_framework_jwt.authentication.JSONWebTokenAuthentication',  # 全局认证方式为JWT认证方式
        'rest_framework.authentication.SessionAuthentication',
        'rest_framework.authentication.BasicAuthentication',
    ),
}
```

#### 3.2添加获取token的路由

创建users这个app并将users和rest_framework注册到项目中，

```python
#users下的url配置
from django.urls import path
from rest_framework_jwt.views import obtain_jwt_token
urlpatterns = [
    path('login/',obtain_jwt_token)
]
```

- 可以在pycharm中连接mysql数据库。

# 三、完成学生登陆接口

见drfstudy仓库里面的promote项目

