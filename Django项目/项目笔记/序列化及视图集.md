# 一、django rest framework的回顾

依次分为写模型，写序列化器，写视图集，写路由这四个部分

### 1.序列化器

1. 序列化
   - 模型或者查询集，将数据转为json传给前端
   - 实例化序列化器（instance）——查询集或模型对象，获取序列化之后的数据——序列化器.data
2. 反序列化
   - 前端转为json，转模型进行操作
   - 实例化序列化器(data)——前端传入的数据，校验前端传入的数据——is_valid()

### 2.视图集

#### 2.1Viewset

路由文件

```python
from django.urls import path
from .views import StudentViewSet
urlpatterns = [
    path('students/',StudentViewSet.as_view({'get':'list','post':'create'})),
    path('students/<pk>',StudentViewSet.as_view({'get':'retrieve','post':'update','delete':'destroy'})),
]
```



带上删除和修改的视图函数

```python
from django.shortcuts import render
from rest_framework import viewsets
from rest_framework.response import Response
# Create your views here.
from .models import Student
from .serializers import StudentSerializer

from rest_framework.status import HTTP_404_NOT_FOUND,HTTP_204_NO_CONTENT


class StudentViewSet(viewsets.ViewSet):
    def list(self,request):
        #获取所有学生的信息，返回的是模型类的集合
        students = Student.objects.all()
        #序列化:传入要转换的模型集合，如果是多条数据，会加入many
        serializer = StudentSerializer(instance= students,many=True)
        #返回响应：返回序列化之后的数据
        return Response(serializer.data)
    def create(self,request):
        #获取前端传入的数据
        # data = request.data #得到前端json数据
        serializer=  StudentSerializer(data=request.data)
        #校验数据
        serializer.is_valid(raise_exception=True)
        #保存数据
        serializer.save()
        return Response(serializer.data)
    def retrieve(self,request,pk):
        try:
            student = Student.objects.get(id = pk)
        except Student.DoesNotExist:
            return Response(status=HTTP_404_NOT_FOUND)
        serializer  =StudentSerializer(instance=student)
        return Response(serializer.data)

    def update(self,request,pk):
        # 获取传入的前端数据
        try:
            student = Student.objects.get(id=pk)
        except Student.DoesNotExist:
            return Response(status=HTTP_404_NOT_FOUND)

        serializer = StudentSerializer(instance=student,data=request.data)  #序列化对象没有传入instance做create，传入则修改
        serializer.is_valid(raise_exception=True)
        serializer.save()

        return Response(serializer.data)

    def destroy(self,request,pk):
        try:
            student = Student.objects.get(id=pk)
        except Student.DoesNotExist:
            return Response(status=HTTP_204_NO_CONTENT)
        student.delete()
        return Response(HTTP_204_NO_CONTENT.data)
```

### 2.2Modelset

```python
from rest_framework import viewsets
from .models import Student
from .serializers import StudentSerializer
class StudentViewSet(viewsets.ModelViewSet):
    queryset = Student.objects.all()    #设置查询集
    serializer_class = StudentSerializer    #设置序列化器
```

- modelset中已经有了上面的增删改查列出所有的五种方法。

### 2.3逻辑删除的实现

模型类中对delete进行修改

```python
    def delete(self,using=None,keep_parents=False):
        self.is_delete = True
        self.save()
```

对modelset类中的查询集进行修改

```python
from rest_framework import viewsets
from .models import Student
from .serializers import StudentSerializer
class StudentViewSet(viewsets.ModelViewSet):
    queryset = Student.objects.filter(is_delete=False)    #设置查询集
    serializer_class = StudentSerializer    #设置序列化器
```

# 二、学生与班级的关联案例

### 1.settings文件

最主要的是日志文件，以及数据库引擎配置，限流的配置，

```python
"""
Django settings for drfstudy project.

Generated by 'django-admin startproject' using Django 3.2.8.

For more information on this file, see
https://docs.djangoproject.com/en/3.2/topics/settings/

For the full list of settings and their values, see
https://docs.djangoproject.com/en/3.2/ref/settings/
"""
import os
import sys
from pathlib import Path

# Build paths inside the project like this: BASE_DIR / 'subdir'.
BASE_DIR = Path(__file__).resolve().parent.parent

#把apps目录加入到sys.path中
sys.path.insert(0,BASE_DIR)
sys.path.insert(1,os.path.join(BASE_DIR,'apps'))


# Quick-start development settings - unsuitable for production
# See https://docs.djangoproject.com/en/3.2/howto/deployment/checklist/

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = 'django-insecure-6g8f(-q=%iyl!lhlsjk4u2x#f3s8j8o!f_tyao!z&1vlk4-5k%'

# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = True

ALLOWED_HOSTS = ['*']


# Application definition

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'rest_framework',
    'user',
]

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

ROOT_URLCONF = 'drfstudy.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

WSGI_APPLICATION = 'drfstudy.wsgi.application'


# Database
# https://docs.djangoproject.com/en/3.2/ref/settings/#databases

DATABASES = {
    'sqlite3': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': BASE_DIR / 'db.sqlite3',
    },
    'default':{
        'ENGINE': 'django.db.backends.mysql',
        'OPTIONS':{
            'read_default_file':'config/dbs/mysql.cnf'
        }

    }

}


# Password validation
# https://docs.djangoproject.com/en/3.2/ref/settings/#auth-password-validators

AUTH_PASSWORD_VALIDATORS = [
    {
        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
    },
]


# 配置日志器，记录网站的日志信息
LOGGING = {
    # 版本
    'version': 1,
    # 是否禁用已存在的日志器
    'disable_existing_loggers': False,
    'formatters': {
        'verbose': {
            'format': '%(levelname)s %(asctime)s %(module)s %(lineno)d %(message)s'
        },
        'simple': {
            'format': '%(levelname)s %(module)s %(lineno)d %(message)s'
        },
    },
    'filters': {
        'require_debug_true': {
            '()': 'django.utils.log.RequireDebugTrue',
        },
    },
    'handlers': {
        'console': {
            'level': 'DEBUG',
            'filters': ['require_debug_true'],
            'class': 'logging.StreamHandler',
            'formatter': 'simple'
        },
        'file': {
            'level': 'INFO',
            'class': 'logging.handlers.RotatingFileHandler',
            'filename': os.path.join(BASE_DIR, "logs/drfstudy.log"),  # 日志文件的位置
            'maxBytes': 300 * 1024 * 1024,
            'backupCount': 10,
            'formatter': 'verbose'
        },
    },
    'loggers': {
        'django': {  # 定义了一个名为django的日志器
            'handlers': ['console', 'file'],
            'propagate': True,
            'level': 'INFO',  # 日志器接收的最低日志级别
        },
    }
}
# Internationalization
# https://docs.djangoproject.com/en/3.2/topics/i18n/

LANGUAGE_CODE = 'zh-hans'

TIME_ZONE = 'Asia/Shanghai'

USE_I18N = True

USE_L10N = True

USE_TZ = False


# Static files (CSS, JavaScript, Images)
# https://docs.djangoproject.com/en/3.2/howto/static-files/

STATIC_URL = '/static/'

# Default primary key field type
# https://docs.djangoproject.com/en/3.2/ref/settings/#default-auto-field

DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'

#限流的使用
REST_FRAMEWORK = {
    'DEFAULT_THROTTLE_CLASSES': [
        'rest_framework.throttling.AnonRateThrottle',
        'rest_framework.throttling.UserRateThrottle'
    ],
    'DEFAULT_THROTTLE_RATES': {
        'anon': '100/day',
        'user': '1000/day'
    }
}
```

### 2.模型文件

```python
from django.db import models

# Create your models here.

class Student(models.Model):
    SEX_CHOICES = (
        (0,'女'),
        (1,'男')
    )
    name = models.CharField(max_length=30,verbose_name='姓名')
    age = models.IntegerField(null=True,verbose_name='年龄',blank=True)
    sex = models.IntegerField(null=True,verbose_name='性别',blank=True,choices=SEX_CHOICES)
    create_time = models.DateTimeField(verbose_name='创建时间',auto_now_add=True)
    update_time = models.DateTimeField(verbose_name='修改时间',auto_now=True)
    is_delete = models.BooleanField(default=False,verbose_name='逻辑删除')
    classes = models.ForeignKey('Classes',on_delete=models.CASCADE) #关联外键

    class Meta:
        db_table = 'student'



    def delete(self,using=None,keep_parents=False):
        self.is_delete = True
        self.save()

class Classes(models.Model):
    name = models.CharField(max_length=30,verbose_name='班级名')
    slogan = models.TextField(blank=True,null=True,verbose_name='班级口号')
    create_time = models.DateTimeField(verbose_name='创建时间', auto_now_add=True)
    update_time = models.DateTimeField(verbose_name='修改时间', auto_now=True)
    is_delete = models.BooleanField(default=False, verbose_name='逻辑删除')

    class Meta:
        db_table = 'classes'

    def delete(self,using=None,keep_parents=False):
        self.is_delete = True
        self.save()
    def __str__(self):
        return self.name

```

### 3.序列化器文件

```python
# -*- coding: utf-8 -*-
# @Time: 2021/10/28 11:03
# @Author: 枫无痕
# @Email: thesky_27@163.com
# @File: serializers.py
# @Software: PyCharm

"""
序列化器：
    本质上是一个类，和模型类差不多的类
    用于json格式与对象模型的转换以及校验数据
    定义的属性就是参与转换的字段
"""
from .models import Student,Classes

from rest_framework import serializers
class StudentSerializer(serializers.ModelSerializer):
    class Meta:
        model = Student
        fields = '__all__'  #指定映射字段，__all__指定所有字段
        # fields = ['id','name','age']    #映射指定字段
        # exclude = ['id']    #映射除了id字段外的所有字段
        extra_kwargs={
            'age':{'min_value':0,'max_value':200},
        }   #改变字段的规则

class ClassesSerializer(serializers.ModelSerializer):
    student_set = StudentSerializer(many=True)
    class Meta:
        model = Classes
        fields = '__all__'

    def validate_name(self,value):
        if '码趣教育' not in value:
            raise serializers.ValidationError('班级名需要码趣教育')
        return value
```

### 4.视图文件

```python
from rest_framework import viewsets
from rest_framework.decorators import action
from rest_framework.response import Response

from .models import Student,Classes
from .serializers import StudentSerializer,ClassesSerializer
class StudentViewSet(viewsets.ModelViewSet):
    queryset = Student.objects.filter(is_delete=False,classes__is_delete=False)    #设置查询集
    serializer_class = StudentSerializer    #设置序列化器
class ClassesViewSet(viewsets.ModelViewSet):
    queryset = Classes.objects.filter(is_delete=False)  # 设置查询集
    serializer_class = ClassesSerializer  # 设置序列化器
    @action(methods=['get'],detail=False)
    def last(self,request):
        classes = Classes.objects.filter(is_delete=False).last()
        serializer = self.get_serializer(classes)
        return Response(serializer.data)
```

### 5.路由文件

```python

from rest_framework.routers import SimpleRouter
from django.urls import path
from .views import StudentViewSet,ClassesViewSet
urlpatterns = [

]
router = SimpleRouter() #创建路由器
router.register('students',StudentViewSet)  #注册路由器
router.register('classes',ClassesViewSet)  #注册路由器
urlpatterns +=router.urls   #拼接进去路由
```

# 三、API文档生成

pip install coreapi

配置文件:

```python
REST_FRAMEWORK = {
    'DEFAULT_THROTTLE_CLASSES': [
        'rest_framework.throttling.AnonRateThrottle',
        'rest_framework.throttling.UserRateThrottle'
    ],
    'DEFAULT_THROTTLE_RATES': {
        'anon': '100/day',
        'user': '1000/day'
    },
    'DEFAULT_SCHEMA_CLASS':'rest_framework.schemas.coreapi.AutoSchema'
}
```

路由配置:

```python
from django.contrib import admin
from django.urls import path,include
from rest_framework.documentation import include_docs_urls

urlpatterns = [
    path('admin/', admin.site.urls),
    path('user/',include('user.urls')),
    path('docs/',include_docs_urls('DRF Study API接口文档')),

]
```



# 注意！！！

```python
"""判断视图类继承哪个类
1.我们是否需要返回json格式的数据，需要，drf结构的视图类，不需要的话，直接使用django的
2.看是否需要使用序列化器和查询集，需要的话就是GenericViewSet，不需要的话就是Viewset
3.我们需要哪些功能，如果是增加，则是CreateModelMixin,修改的话就是UpdateModelMixin
    如果五个都要，则会继承ModelView
4.直接继承ModelView,肯定不会出错，但是会出现代码冗余
"""
```

