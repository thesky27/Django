# 第六章：常用查询及表关系

### 1.查询

```python
def select_user(request):

    #常用的查询方法
    res = User.objects.filter(name__contains='小')
    res1 = User.objects.filter(name__in=['小黑','铵盐'])
    res2 = User.objects.filter(name__startswith='铵')
    res = User.objects.exclude(age=18) # 排除查询
    res = User.objects.order_by('age')  # 从小到大排序
    res = User.objects.order_by('-age')  # 从大到小排序
    res = User.objects.order_by('-age','id')  # 先根据age排序，再根据id排序排序
    res = User.objects.filter(age__gt=20)   #大于20
    res = User.objects.filter(age__lt=20) #小于20
    res = User.objects.filter(age__in=[20,19,38])
    res = User.objects.filter(age__range=(20,38))   #大于等于20小于等于38

    res1 = User.objects.count() #获取一共有多少数据
    res1 = User.objects.all().values() #将查询到的数据转为字典
    print(res)
    print(res1)

    return HttpResponse('数据查询成功')
```

### 2.常用的字段数据

- integerField——整型，charField——字符类型，booleanfield——布尔类型
- TextField——文本类型，datefield——日期类型，没有时间，
- datetimefield。

### 3.field常用参数

默认都是非空元素

- primary_key——主键
- unique——唯一，datefile
- null——空，default——设置默认值
- blank——等于true时，form表单的验证可以为空，默认为false

```python
class Field_test(models.Model):
    id = models.AutoField(primary_key=True)
    name = models.CharField(max_length=20,unique=True)
    age = models.IntegerField()
    intro = models.TextField(null=True)
    create_time = models.DateField(auto_now_add=True)   #自动记录数据创建时间
    update_time = models.DateTimeField(auto_now=True)   #自动记录数据更新时间
    
    
# 修改时间时，必须要保存，才能修改已经存在的时间
res = Field_test.objects.get(id=1)
res.age=96
res.intro="按闫真的是64岁"
res.save()
# \G——更改输出的格式
```

### 4.修改为北京时间

在主项目settings文件里面修改

```python
LANGUAGE_CODE = 'zh-hans'

TIME_ZONE = 'Asia/Shanghai'

USE_I18N = True

USE_L10N = True

USE_TZ = False

```

# 第七章：表关系

### 1.表关系模型的建立

外键

```python
### 1.一对多
外键
### 2.一对一
外键加唯一键
### 3.多对多
关联表加外键加联合唯一
#学院信息表
class Department(models.Model):
    d_id = models.AutoField(primary_key=True)
    d_name = models.CharField(max_length=30,unique=True)

    def __str__(self):
        return f'd_id={self.d_id},d_name={self.d_name}'
#学生表格
class Student(models.Model):
    s_id = models.AutoField(primary_key=True)
    s_name = models.CharField(max_length=30)
    dept_id=models.ForeignKey('Department',on_delete=models.SET_NULL,null=True)

    def __str__(self):
        return f's_id={self.s_id},s_name={self.s_name},dept_id={self.dept_id}'
#学生详情表
class Stu_datail(models.Model):
    sd_id  =models.AutoField(primary_key=True)
    age = models.IntegerField()
    sex = models.BooleanField(default=True)
    intro = models.TextField(null=True)
    s_id = models.OneToOneField('Student',on_delete=models.CASCADE)

    def __str__(self):
        return f'sd_id={self.sd_id},sd_name={self.sd_name},age={self.age},sex={self.sex},intro={self.intro}'

# 学生课程表
class Course(models.Model):
    c_id = models.AutoField(primary_key=True)
    c_name = models.CharField(max_length=30,unique=True)
    stu_course = models.ManyToManyField('Student')

    def __str__(self):
        return f'c_id={self.c_id},c_name={self.c_name}'
```

### 2.表关系的添加

```python
def add(request):
    #学院表
    # Department.objects.get_or_create(d_name='文学院')
    # Department.objects.get_or_create(d_name='理学院')
    # Department.objects.get_or_create(d_name='机电学院')
    # Department.objects.get_or_create(d_name='软件学院')
    # Department.objects.get_or_create(d_name='设计学院')

    #学生表
    # Student.objects.get_or_create(s_name='小红',dept_id_id=3)
    # Student.objects.get_or_create(s_name='小黑',dept_id_id=4)
    # Student.objects.get_or_create(s_name='小橙',dept_id_id=1)
    # Student.objects.get_or_create(s_name='小黄',dept_id_id=2)
    # Student.objects.get_or_create(s_name='小绿',dept_id_id=5)

    #学生详情
    # Stu_datail.objects.get_or_create(age=18,sex=0,intro='小红真漂亮',s_id_id=1)
    # Stu_datail.objects.get_or_create(age=19,sex=1,intro='小黑有点黑',s_id_id=2)
    # Stu_datail.objects.get_or_create(age=18,sex=0,intro='小橙还年轻',s_id_id=3)
    # Stu_datail.objects.get_or_create(age=18,sex=0,intro='小红是老大',s_id_id=4)
    # Stu_datail.objects.get_or_create(age=18,sex=1,intro='小绿真的绿',s_id_id=5)

    # Course.objects.get_or_create(c_name='语文')
    # Course.objects.get_or_create(c_name='数学')
    # Course.objects.get_or_create(c_name='英语')
    # Course.objects.get_or_create(c_name='Python')
    # Course.objects.get_or_create(c_name='Web')

    #学生课程中间表
    c1 = Course.objects.get(c_id=1)
    c2 = Course.objects.get(c_id=2)
    c3 = Course.objects.get(c_id=3)
    c4 = Course.objects.get(c_id=4)
    c5 = Course.objects.get(c_id=5)

    s1 = Student.objects.get(s_id=1)
    s2 = Student.objects.get(s_id=2)
    s3 = Student.objects.get(s_id=3)

    #给学生分配课程——反向访问
    s1.course_set.add(c1,c2,c3)
    #给课程分配学生——正向访问
    c1.stu_course.add(s2,s3)
    #通过学生创建课程表
    s2.course_set.create(c_name='爬虫')
    #通过学院来添加新学生
    d4 = Department.objects.get(d_id=4)
    d4.student_set.create(s_name='小青')
    return HttpResponse('数据添加成功')
```

### 3.表关系的查询

```python
def query(request):

    # 一对多查询
    s1 = Student.objects.get(s_id=1)
    # d1 = Department.objects.get(d_id=1)
    #正向访问
    # res = s1.dept_id.d_name #当前学生的名字
    #反向访问
    # res=d1.student_set.all()[0].s_name

    #一对一学生详情
    # res = Stu_datail.objects.get(sd_id=1)
    # res = res.s_id.s_name
    # s1 = Student.objects.get(s_id=4)
    # res = s1.stu_datail

    #多对多关系
    c1 = Course.objects.get(c_id=1)
    res = s1.course_set.all()
    res = c1.stu_course.all()

    return HttpResponse(res)
```

### 4.表关系的删除

```python
def remove(request):

    c1 = Course.objects.get(c_id=1)
    c2 = Course.objects.get(c_id=2)
    s1 = Student.objects.get(s_id=1)

    # s1.course_set.remove(c2)

    #删除一号学生报名的全部课程
    s1.course_set.clear()
    c1.stu_course.clear()

    return HttpResponse('学生数据删除成功')
```

### 5.表关系的修改

```python
def update(request):
    s1 =Student.objects.get(s_id=1)
    d4 = Department.objects.get(d_id=4)
    d4.student_set.add(s1)  #把一号学生改成四号学院

    return HttpResponse('数据修改成功')
```

### 6.多表连接查询
